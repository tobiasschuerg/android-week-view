name: Build and Quality Checks
on:
  push:
    branches:
      - master
      - develop
  pull_request_target:

permissions:
  checks: write
  contents: write
  pull-requests: write

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run lint
        run: ./gradlew lintDebug

      - name: Run detekt
        run: ./gradlew detekt

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

  build:
    needs: quality-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build debug APK
        run: ./gradlew assembleDebug

  dependabot_info:
    if: ${{ github.event_name == 'pull_request_target' && github.actor == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **Dependabot PR detected**\n\nAuto-merge will be enabled after all checks pass for patch and minor updates.'
            })

  auto-merge:
    name: Auto-merge Eligible Dependabot PR
    runs-on: ubuntu-latest
    needs: [ quality-checks, build ]
    if: ${{ github.event_name == 'pull_request_target' && github.actor == 'dependabot[bot]' }}
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Debug auto-merge condition
        run: |
          echo "DEBUG: Auto-merge job started"
          echo "Actor: ${{ github.actor }}"
          echo "Quality-checks result: ${{ needs.quality-checks.result }}"
          echo "Build result: ${{ needs.build.result }}"

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show metadata
        run: |
          echo "Update type: ${{ steps.metadata.outputs.update-type }}"
          echo "Dependency names: ${{ steps.metadata.outputs.dependency-names }}"

      - name: Approve PR
        if: |
          github.actor == 'dependabot[bot]' && (
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor')
        continue-on-error: true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review --approve "$PR_URL"

      - name: Enable auto-merge for patch and minor updates
        id: auto_merge
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        continue-on-error: true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge --auto --squash "$PR_URL"
          echo "Auto-merge enabled. PR will merge automatically when all checks pass."

      - name: Add auto-merged label
        if: steps.auto_merge.outcome == 'success'
        continue-on-error: true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: gh pr edit $PR_NUMBER --add-label "auto-merged"

      - name: Comment on auto-merge failure
        if: |
          steps.auto_merge.outcome == 'failure' &&
          (steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.metadata.outputs.update-type == 'version-update:semver-minor')
        continue-on-error: true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "$PR_URL" --body "‚ö†Ô∏è Auto-merge could not be enabled. Possible reasons:
          - Branch protection rules are not satisfied
          - Required status checks are not configured
          - PR has conflicts

          Please review and merge manually."

      - name: Comment on major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        continue-on-error: true
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "$PR_URL" --body "‚ö†Ô∏è This is a **major version update**. Auto-merge is disabled for major updates.

          Please review carefully and merge manually after testing."
